<view class="container">
  <!-- 课文详情内容 -->
  <view class="article-container">
    <!-- 分享按钮（悬浮） -->
    <view class="share-button" bindtap="onShareTap">
      <text class="share-text">分享</text>
    </view>

    <!-- 原文区域 -->
    <view class="original-section">
      <!-- 标题和收藏区域 -->
      <view class="title-container">
      <view class="article-title">{{article.title}}</view>
        <view class="title-collect" bindtap="toggleCollect">
          <text class="collect-text {{isCollected ? 'collected' : ''}}">{{isCollected ? '已收藏' : '收藏'}}</text>
        </view>
      </view>
      
      <!-- 作者和朝代信息 -->
      <view class="author-info">
        <view class="info-item">
          <text class="info-label">作者：</text>
          <text class="info-value">{{article.author}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">朝代：</text>
          <text class="info-value">{{article.dynasty}}</text>
        </view>
      </view>
      
      <!-- 原文内容 -->
      <view class="ancient-text-container {{isContentCollapsed && showToggleButton ? 'collapsed' : showToggleButton ? (isAutoExpand ? 'auto' : 'expanded') : ''}}">
        <!-- 底部滚动提示 -->
        <view wx:if="{{showScrollTip && !isContentCollapsed && !isAutoExpand}}" class="scroll-tip-bottom">可上下滑动查看更多</view>
        <scroll-view scroll-y="{{!isContentCollapsed && showToggleButton && !isAutoExpand}}" bindscroll="onAncientScroll" style="height:100%;">
          <view class="ancient-text">{{article.full_content}}</view>
        </scroll-view>
        <!-- 底部渐变遮罩 -->
        <view wx:if="{{(isContentCollapsed && showToggleButton) || (!isContentCollapsed && showBottomMask && !isAutoExpand)}}" class="ancient-bottom-mask"></view>
      </view>
      
      <!-- 展开/收起按钮 -->
      <view class="toggle-content-button" bindtap="toggleContent" wx:if="{{showToggleButton}}">
        <view class="toggle-button-text">{{isContentCollapsed ? '展开全文' : '收起全文'}}</view>
        <view class="toggle-button-icon {{isContentCollapsed ? 'collapsed' : ''}}"></view>
      </view>
      </view>
      
    <!-- 功能选项卡 -->
    <view class="tab-container">
      <view class="tab-item {{currentTab === 'translation' ? 'active' : ''}}" bindtap="switchTab" data-tab="translation">
        <image class="tab-icon" src="/images/icons/translation.svg" mode="aspectFit"></image>
        <text>全文翻译</text>
      </view>
      <view class="tab-item {{currentTab === 'analysis' ? 'active' : ''}}" bindtap="switchTab" data-tab="analysis">
        <image class="tab-icon" src="/images/icons/analysis.svg" mode="aspectFit"></image>
        <text>逐句解析</text>
      </view>
      <view class="tab-item {{currentTab === 'author' ? 'active' : ''}}" bindtap="switchTab" data-tab="author">
        <image class="tab-icon" src="/images/icons/author.svg" mode="aspectFit"></image>
        <text>作者介绍</text>
      </view>
      <view class="tab-item {{currentTab === 'background' ? 'active' : ''}}" bindtap="switchTab" data-tab="background">
        <image class="tab-icon" src="/images/icons/background.svg" mode="aspectFit"></image>
        <text>背景知识</text>
      </view>
      <view class="tab-item {{currentTab === 'exercise' ? 'active' : ''}}" bindtap="switchTab" data-tab="exercise">
        <image class="tab-icon" src="/images/icons/exercise.svg" mode="aspectFit"></image>
        <text>练习巩固</text>
      </view>
      <view class="tab-item {{currentTab === 'qa' ? 'active' : ''}}" bindtap="switchTab" data-tab="qa">
        <image class="tab-icon" src="/images/icons/ai.svg" mode="aspectFit"></image>
        <text>AI互动</text>
      </view>
    </view>

    <!-- 内容区域 -->
    <view class="content-container">
      <!-- 翻译 -->
      <view class="content-section" wx:if="{{currentTab === 'translation'}}">
        <view class="translation-content">
          <!-- 翻译加载中 -->
          <view class="section-loading" wx:if="{{aiProcessing && !article.translation}}">
            <view class="section-loading-spinner"></view>
            <text class="section-loading-text">AI思考中...</text>
          </view>
          <view class="translation-section" wx:else>
            <view class="section-title">白话文翻译</view>
            <text class="modern-text" decode="{{true}}">{{article.translation}}</text>
          </view>
        </view>
      </view>

      <!-- 作者介绍 -->
      <view class="content-section" wx:if="{{currentTab === 'author'}}">
        <view class="author-content">
          <!-- 作者介绍加载中 -->
          <view class="section-loading" wx:if="{{aiProcessing && !article.author_intro}}">
            <view class="section-loading-spinner"></view>
            <text class="section-loading-text">AI思考中...</text>
          </view>
          <view class="author-section" wx:else>
            <view class="author-header">
                <text class="author-name">{{article.author}}</text>
                <text class="author-dynasty">{{article.dynasty}}</text>
            </view>
            <text class="author-bio" decode="{{true}}">{{article.author_intro}}</text>
          </view>
        </view>
      </view>

      <!-- 逐句解析 -->
      <view class="content-section" wx:if="{{currentTab === 'analysis'}}">
        <view class="analysis-content">
          <!-- 简化后的句子导航 -->
          <view class="navigation-toolbar">
            <view class="nav-button {{currentSentenceIndex === 0 ? 'disabled' : ''}}" bindtap="prevSentence">
              <text>上一句</text>
            </view>
            
            <view class="nav-button sentence-list-btn" bindtap="showSentenceList">
              <text>句子列表 ({{currentSentenceIndex + 1}}/{{sentences.length}})</text>
            </view>
            
            <view class="nav-button {{currentSentenceIndex === sentences.length - 1 ? 'disabled' : ''}}" bindtap="nextSentence">
              <text>下一句</text>
            </view>
          </view>

          <!-- 句子解析加载中 -->
          <view class="section-loading" wx:if="{{aiProcessing && (!sentences[currentSentenceIndex].phonetic_notation || !sentences[currentSentenceIndex].translation)}}">
            <view class="section-loading-spinner"></view>
            <text class="section-loading-text">AI思考中...</text>
          </view>
          <view class="sentence-card" wx:else>
            <view class="sentence-section">
              <view class="section-title">原文</view>
              <view class="section-content original">{{sentences[currentSentenceIndex].original_text}}</view>
            </view>
            
            <view class="sentence-section">
              <view class="section-title">拼音</view>
              <text class="section-content pinyin" decode="{{true}}">{{sentences[currentSentenceIndex].phonetic_notation}}</text>
            </view>
            
            <view class="sentence-section">
              <view class="section-title">翻译</view>
              <text class="section-content translation" decode="{{true}}">{{sentences[currentSentenceIndex].translation}}</text>
            </view>
            
            <view class="sentence-section">
              <view class="section-title">关键词解释</view>
              <view class="section-content keywords">
                <block wx:for="{{sentences[currentSentenceIndex].key_words}}" wx:key="*this" wx:for-item="keyword">
                  <view class="keyword-item">
                    <!-- 显示带有数字编号的关键词 -->
                    <view class="keyword-header">
                      <text class="keyword-number" wx:if="{{keyword.number}}">{{keyword.number}}</text>
                      <text class="keyword">{{keyword.word}}</text>
                    </view>
                    <text class="explanation">{{keyword.explanation}}</text>
                  </view>
                </block>
              </view>
            </view>
            
            <view class="sentence-section">
              <view class="section-title">语法结构</view>
              <text class="section-content structure" decode="{{true}}">{{sentences[currentSentenceIndex].grammar_analysis}}</text>
            </view>
            
            <view class="sentence-section">
              <view class="section-title">修辞手法</view>
              <text class="section-content rhetoric" decode="{{true}}">{{sentences[currentSentenceIndex].rhetorical_analysis}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 背景知识 -->
      <view class="content-section" wx:if="{{currentTab === 'background'}}">
        <view class="background-content">
          <!-- 背景知识加载中 -->
          <view class="section-loading" wx:if="{{aiProcessing && !article.background_info}}">
            <view class="section-loading-spinner"></view>
            <text class="section-loading-text">AI思考中...</text>
          </view>
          <block wx:else>
            <view class="background-section">
              <view class="section-title">创作背景</view>
                <text class="section-content" decode="{{true}}">{{article.creation_background}}</text>
            </view>
            <view class="background-section">
              <view class="section-title">历史背景</view>
                <text class="section-content" decode="{{true}}">{{article.historical_background}}</text>
            </view>
            <view class="background-section">
              <view class="section-title">主旨思想</view>
                <text class="section-content" decode="{{true}}">{{article.main_idea}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- 练习巩固 -->
      <view class="content-section" wx:if="{{currentTab === 'exercise'}}">
        <!-- AI加载动画 -->
        <view class="section-loading" wx:if="{{aiProcessing}}">
            <view class="section-loading-spinner"></view>
          <text class="section-loading-text">AI出题中</text>
        </view>
        <!-- 答题前：只显示当前题目 -->
        <view class="exercise-section" wx:elif="{{!aiProcessing && !showExerciseResult}}">
          <block wx:if="{{exercises.length > 0}}">
            <view class="exercise-card">
              <view class="exercise-header">
                <view class="exercise-question">{{currentExerciseIndex + 1}}. {{exercises[currentExerciseIndex].question}}</view>
                <view class="exercise-progress-indicator">{{currentExerciseIndex + 1}}/{{exercises.length}}</view>
              </view>
              <view class="exercise-options">
                <block wx:for="{{exercises[currentExerciseIndex].options}}" wx:for-item="opt" wx:for-index="optIdx" wx:key="optIdx">
                  <view class="{{optionClassList[currentExerciseIndex][optIdx]}}"
                        bindtap="selectExerciseOption"
                        data-question-index="{{currentExerciseIndex}}"
                        data-option-index="{{optIdx}}">
                    <text class="option-letter">{{optionLetters[optIdx]}}</text>
                    <text class="option-content">{{opt}}</text>
                    <block wx:if="{{userAnswers[currentExerciseIndex] === optIdx}}">
                      <view class="option-selected-icon"></view>
                    </block>
                  </view>
                </block>
              </view>
              <!-- 导航按钮 -->
              <view class="exercise-nav-buttons">
                <button class="nav-btn prev-btn" bindtap="prevExercise" disabled="{{currentExerciseIndex === 0}}">上一题</button>
                <button class="nav-btn next-btn" bindtap="nextExercise" disabled="{{currentExerciseIndex === exercises.length - 1}}">下一题</button>
              </view>
              <!-- 提交按钮 -->
              <view class="exercise-submit-bar" wx:if="{{currentExerciseIndex === exercises.length - 1}}">
                <button class="exercise-submit-btn" bindtap="submitExercises">提交答案</button>
              </view>
            </view>
          </block>
        </view>
        <!-- 答题后：显示所有题目、用户选择、正确答案、解析、得分和重新作答按钮 -->
        <view class="exercise-section" wx:elif="{{!aiProcessing && showExerciseResult}}">
          <view class="exercise-score-bar">
            <text>得分：{{exerciseScore}} / {{exercises.length}}</text>
          </view>
          <block wx:for="{{exercises}}" wx:for-item="ex" wx:for-index="idx" wx:key="idx">
            <view class="exercise-card">
              <view class="exercise-header">
                <view class="exercise-question">{{idx + 1}}. {{ex.question}}</view>
                <view class="exercise-result-tag {{userAnswers[idx] === ex.answer ? 'correct' : 'wrong'}}">
                  {{userAnswers[idx] === ex.answer ? '正确' : '错误'}}
                </view>
              </view>
              <view class="exercise-options">
                <block wx:for="{{ex.options}}" wx:for-item="opt" wx:for-index="optIdx" wx:key="optIdx">
                  <view class="{{optionClassList[idx][optIdx]}}">
                    <text class="option-letter">{{optionLetters[optIdx]}}</text>
                    <text class="option-content">{{opt}}</text>
                    <block wx:if="{{showExerciseResult}}">
                      <view wx:if="{{optIdx === ex.answer && userAnswers[idx] === optIdx}}" class="option-result-icon correct-selected"></view>
                      <view wx:elif="{{optIdx === ex.answer}}" class="option-result-icon correct"></view>
                      <view wx:elif="{{userAnswers[idx] === optIdx}}" class="option-result-icon wrong"></view>
                    </block>
                  </view>
                </block>
              </view>
              <view class="exercise-analysis" wx:if="{{showExerciseResult}}">
                <text class="analysis-title">解析：</text>
                <text class="analysis-content">{{ex.analysis}}</text>
              </view>
            </view>
          </block>
          <view class="exercise-reset-bar">
            <button class="exercise-reset-btn" bindtap="resetExercises">重新答题</button>
          </view>
        </view>
      </view>

      <!-- 提问拓展 -->
      <view class="content-section" wx:if="{{currentTab === 'qa'}}">
        <view class="ai-content">
          <!-- AI助手头部 -->
          <view class="ai-header">
            <view class="ai-avatar-container">
              <image class="ai-avatar" src="/images/laibai-avatar.png" mode="aspectFill"></image>
            </view>
            <view class="ai-intro">
              <view class="ai-name">文言文学习助手 · 李白</view>
              <view class="ai-description">你好！我是你的文言文学习助手。关于《{{article.title}}》，你有什么想问的吗？</view>
            </view>
          </view>
          
          <!-- AI加载动画 -->
          <view class="section-loading" wx:if="{{aiProcessing}}">
            <view class="section-loading-spinner"></view>
            <text class="section-loading-text">AI思考问题中...</text>
          </view>
          
          <!-- 推荐问题区域 -->
          <view class="suggested-questions" wx:else>
            <view class="suggestion-title">推荐问题</view>
            <view class="suggestion-list">
              <view class="suggestion-item" 
                    wx:for="{{suggestedQuestions}}" 
                    wx:key="*this" 
                    bindtap="tapSuggestedQuestion" 
                    data-question="{{item}}">
                <view class="suggestion-icon"></view>
                <text>{{item}}</text>
              </view>
            </view>
          </view>
          
          <!-- 输入区域 -->
          <view class="input-container">
            <input class="question-input" 
                   placeholder="输入你的问题..." 
                   value="{{userQuestion}}" 
                   bindinput="inputQuestion" 
                   confirm-type="send"
                   bindconfirm="askQuestion" />
            <view class="send-button" bindtap="askQuestion">
              <text>提问</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 句子列表弹窗 -->
  <view class="sentence-list-drawer {{showSentenceListDrawer ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="drawer-header">
      <view class="drawer-title">句子列表</view>
      <view class="drawer-close" bindtap="closeSentenceList">×</view>
    </view>
    <view class="drawer-content">
      <scroll-view scroll-y class="sentence-list">
        <view wx:for="{{sentences}}" wx:key="index" 
              class="sentence-list-item {{currentSentenceIndex === index ? 'current' : ''}}" 
              bindtap="selectSentenceFromList" data-index="{{index}}">
          <view class="sentence-number">{{index + 1}}</view>
          <view class="sentence-text">{{item.original_text}}</view>
        </view>
      </scroll-view>
    </view>
  </view>
  
  <!-- 背景蒙层，点击关闭句子列表 -->
  <view class="drawer-mask {{showSentenceListDrawer ? 'show' : ''}}" bindtap="closeSentenceList"></view>
</view>

# 蜗牛学诗文小程序

这是一款专为中小学生设计的文言文学习微信小程序，通过AI技术，帮助学生更轻松地理解文言文，提高古文阅读能力和考试成绩。

## 项目结构

```
wenyanwen/
├── miniprogram/              # 小程序源代码目录
│   ├── app.js                # 小程序全局逻辑
│   ├── app.json              # 小程序全局配置
│   ├── app.wxss              # 小程序全局样式
│   ├── sitemap.json          # 小程序SEO配置
│   ├── cloudfunctions/       # 云函数目录
│   │   ├── login/            # 用户登录云函数
│   │   ├── updateUserArticleRecord/  # 更新用户文章学习记录
│   │   ├── updateFunctionClick/      # 更新功能点击状态
│   │   ├── updateLearnDuration/      # 更新学习时长
│   │   ├── getUserArticleRecords/    # 获取用户文章学习记录
│   │   ├── getAIContent/             # 获取AI内容云函数
│   │   ├── saveAIContent/            # 保存AI内容云函数
│   │   ├── userAIChat/               # AI聊天云函数
│   │   └── uploadTestArticles/       # 上传测试文章
│   ├── components/           # 自定义组件目录
│   ├── images/               # 图片资源目录
│   ├── pages/                # 页面目录
│   │   ├── index/            # 首页
│   │   │   ├── index.js      # 首页逻辑
│   │   │   ├── index.wxml    # 首页结构
│   │   │   └── index.wxss    # 首页样式
│   │   ├── article/          # 课文相关页面
│   │   │   └── detail/       # 课文详情页
│   │   ├── course/           # 课程相关页面
│   │   │   └── select/       # 课文选择页面
│   │   │       ├── select.js   # 课文选择页面逻辑
│   │   │       ├── select.wxml # 课文选择页面结构
│   │   │       └── select.wxss # 课文选择页面样式
│   │   ├── word-learning/    # 虚实词学习相关页面
│   │   │   ├── index/        # 虚实词学习首页
│   │   │   ├── word-list/    # 词条列表页面
│   │   │   ├── study/        # 学习页面
│   │   │   └── review/       # 复习页面
│   │   ├── ai/               # AI助手页面
│   │   │   └── index/        # AI助手首页
│   │   ├── my/               # 我的页面
│   │   │   └── index/        # 个人中心首页
│   │   └── logs/             # 日志页面
│   ├── styles/               # 样式目录
│   └── utils/                # 工具函数目录
│       ├── ai.js             # AI功能工具函数
│       ├── ai-storage.js     # AI内容存储工具函数
│       ├── request.js        # 网络请求工具函数
│       └── util.js           # 通用工具函数
├── project.config.json       # 项目配置文件
├── project.private.config.json # 项目私有配置文件
└── xuqiu.md                  # 需求文档
```

## 页面结构详解

### 1. 课文选择页面 (miniprogram/pages/course/select/)

课文选择页面允许用户按年级和学期浏览和选择课文。

**核心功能：**
- 按年级和学期分类展示课文列表
- 支持课文搜索功能
- 自动定位到上次学习的课文
- 课文选择后跳转到详情页

**主要实现文件：**
- `select.js` - 页面逻辑：包含年级列表获取、课文列表获取、课文搜索和选择等功能
- `select.wxml` - 页面结构：包含左侧年级列表和右侧课文列表的布局
- `select.wxss` - 页面样式：中国风UI样式定义

**数据交互：**
- 从云数据库 `articles` 集合获取课文数据
- 将选中的课文保存到本地存储

### 2. 文章详情页面 (miniprogram/pages/article/detail/)

文章详情页面是用户学习文言文的核心页面，提供原文阅读、翻译、解析等功能。

**核心功能：**
- 展示文言文原文
- 提供全文翻译功能
- 逐句解析功能，帮助理解句子结构和含义
- 作者介绍，了解作者背景
- 背景知识，了解文章创作背景和历史背景
- 练习巩固，通过练习题加深理解
- AI互动，可以针对文章提问

**学习进度跟踪：**
- 记录用户在文章页面的停留时长
- 跟踪用户使用的功能模块
- 根据功能使用情况判断学习完成度

### 3. 首页 (miniprogram/pages/index/)

首页是用户进入小程序的第一个页面，提供各种功能入口。

**主要实现文件：**
- `index.js` - 首页逻辑
- `index.wxml` - 首页结构
- `index.wxss` - 首页样式

## 功能模块

### 1. 首页

- 欢迎区域：根据时间段显示不同欢迎语
- 继续学习区域：显示用户最近学习的内容
- 课文精讲区域：学习课文的主要入口
- 名句赏析区域：精选文言文经典名句
- 推广领取区域：提供学习资料领取

### 2. 课文学习

- 课文选择：按年级分类选择课文
- 课文学习：包含原文、翻译、逐句解析、背景知识等
- 练习巩固：基于课文生成的练习题
- 提问拓展：用户可针对课文提出任何问题获取解答

### 3. 虚实词学习模块

- 首页：选择高考或中考虚实词分类
- 学习进度：展示已掌握、待复习、学习中和待学习的词条数量及进度
- 分类选择：通过卡片式UI选择不同类别的虚实词
- 词条列表：展示选定类别的词条清单
- 学习页面：展示词条、词性、基本词义、例句和释义
- 复习页面：针对性复习已学习的虚实词

### 4. AI助手

- 拟人化AI助手（李白），回答用户提出的文言文相关问题
- 支持文言文翻译、古诗创作、文学典故讲解等功能
- 聊天记录存储与同步

### 5. 个人中心

- VIP会员：会员权益与购买管理
- 学习统计：展示用户学习数据
- 我的错题集：收集整理用户做错的题目
- 我的收藏：管理收藏的内容

### 6. 版本自动更新
- 小程序启动时自动检查新版本。
- 当有新版本时，会弹窗提示用户是否立即重启以应用更新。
- 如果更新失败，会给出相应提示。

## 云函数详解

### 1. login（用户登录）

**功能说明：**
- 获取用户openid及基本信息
- 处理用户首次登录的自动注册
- 支持用户信息更新（昵称、头像等）

**主要参数：**
- `action`: 操作类型（check/updateNickname/update/logout）
- `userData`: 用户数据（昵称、头像等）

**核心逻辑：**
- 检查用户是否已注册，未注册则自动创建用户记录
- 生成随机昵称（"书生+4位数字"格式）
- 支持更新用户昵称和头像等信息

### 2. updateUserArticleRecord（更新用户文章学习记录）

**功能说明：**
- 创建或更新用户对特定文章的学习记录
- 记录用户最后学习时间
- 更新学习状态（未开始/学习中/已完成）

**主要参数：**
- `articleId`: 文章ID

**核心逻辑：**
- 检查文章ID是否有效（支持_id和article_id两种形式）
- 查询用户是否已有该文章的学习记录
- 如无记录则创建新记录，有则更新最后学习时间
- 根据功能点击情况判断学习状态

### 3. updateFunctionClick（更新功能点击状态）

**功能说明：**
- 记录用户在文章学习页面使用的功能模块
- 跟踪六大功能模块的使用情况
- 根据功能使用情况更新学习完成度

**主要参数：**
- `articleId`: 文章ID
- `functionIndex`: 功能索引（1-6，对应六大功能模块）

**核心逻辑：**
- 更新对应功能的点击状态（func1_clicked ~ func6_clicked）
- 记录功能点击历史（功能名称和时间）
- 检查是否所有功能都已点击，如是则将学习状态更新为"已完成"

**功能索引对应关系：**
1. 全文翻译
2. 逐句解析
3. 作者介绍
4. 背景知识
5. 练习巩固
6. AI互动

### 4. updateLearnDuration（更新学习时长）

**功能说明：**
- 记录用户在文章页面的学习时长
- 累计计算总学习时间
- 更新学习状态

**主要参数：**
- `articleId`: 文章ID
- `duration`: 本次学习时长（秒）

**核心逻辑：**
- 验证学习时长有效性
- 查找用户文章学习记录
- 累加学习时长
- 根据功能点击情况更新学习状态

### 5. getUserArticleRecords（获取用户文章学习记录）

**功能说明：**
- 获取用户的文章学习历史记录
- 支持获取最新一条学习记录
- 关联文章信息，提供完整学习数据

**主要参数：**
- `type`: 记录类型（'history'或'latest'）

**核心逻辑：**
- 根据type参数决定返回全部历史记录或最新一条记录
- 查询用户的学习记录
- 关联文章信息（标题、作者、朝代等）
- 处理分页和数据合并

### 6. getAIContent（获取AI内容）

**功能说明：**
- 获取文章的AI生成内容（翻译、解析、背景知识等）
- 通过云函数实现，避免客户端权限问题
- 确保不同用户访问同一文章时共享AI内容

**主要参数：**
- `articleId`: 文章ID
- `type`: 内容类型（translate/sentence_analysis/author_info等）
- `extra`: 额外参数（如句子内容等）

**核心逻辑：**
- 使用管理员权限查询article_ai_content集合
- 根据article_id和type查找对应内容
- 返回查询结果给客户端

### 7. saveAIContent（保存AI内容）

**功能说明：**
- 保存或更新文章的AI生成内容
- 通过云函数实现，避免客户端权限问题
- 确保同一篇文章在数据库中只有一条记录

**主要参数：**
- `articleId`: 文章ID
- `type`: 内容类型
- `content`: 内容数据
- `extra`: 额外参数
- `timestamp`: 时间戳

**核心逻辑：**
- 检查是否已有该文章记录
- 如有记录则更新内容，无则创建新记录
- 特殊处理句子解析等复杂内容类型
- 使用管理员权限操作数据库

### 8. generateFamousQuotes（生成名句数据）

**功能说明：**
- 生成50条精选名句数据并存储到云数据库
- 提供名句内容、出处、作者、朝代和现代汉语翻译

**核心逻辑：**
- 预设50条精选名句数据
- 将名句数据批量存入cloud数据库的`famous_quotes`集合中
- 确保名句数据可被前端页面调用

### 9. getRandomQuote（获取随机名句）

**功能说明：**
- 从数据库中随机获取一条名句
- 用于首页名句展示功能

**核心逻辑：**
- 获取名句总数
- 生成随机索引
- 使用skip和limit方法获取随机名句
- 返回名句数据给前端

### 10. userFavorite（用户收藏管理）

**功能说明：**
- 管理用户收藏的名句和文章
- 支持添加收藏、取消收藏、检查收藏状态和获取收藏列表

**主要参数：**
- `action`: 操作类型（add/remove/check/list）
- `type`: 收藏类型（quote/article）
- `id`: 收藏项目ID
- `data`: 收藏项目数据（添加收藏时使用）

**核心逻辑：**
- 添加收藏：将名句或文章数据存入user_favorite集合
- 取消收藏：从user_favorite集合中删除对应记录
- 检查收藏：查询是否存在对应收藏记录
- 获取列表：返回用户所有收藏项目，支持按类型筛选

### 11. userAIChat（AI聊天）
**功能说明：**
- 存储和获取用户与AI助手的聊天记录。
- 支持获取历史消息、添加新消息以及清空记录。

**主要参数：**
- `action`: 操作类型 (`getHistory`, `addMessage`, `clearHistory`)
- `message`: 用户发送的消息对象 (仅在 `addMessage` 时需要)

**核心逻辑：**
- `getHistory`: 查询并返回当前用户的聊天记录。
- `addMessage`: 将用户和AI的新消息追加到聊天记录中。
- `clearHistory`: 删除当前用户的所有聊天记录。

### 12. uploadTestArticles（上传测试文章）

**功能说明：**
- 用于批量上传测试文章数据到云数据库
- 仅用于开发测试阶段

### 13. getXushiciData（获取虚实词数据）

**功能说明：**
- 获取虚实词数据，包括词条列表和详细信息
- 支持按分类（高考实词、高考虚词、中考实词、中考虚词）筛选
- 获取分类信息和词条数量

**主要参数：**
- `type`: 操作类型（'getList'/'getDetail'/'getCategoryInfo'）
- `category`: 分类名称（如'高考实词合集'）
- `wordId`: 词条ID（获取详情时使用）

**核心逻辑：**
- 根据type参数决定返回词条列表、词条详情或分类信息
- 支持分页获取词条列表
- 关联例句和用法信息

### 14. getUserWordProgress（获取用户虚实词学习进度）

**功能说明：**
- 获取用户的虚实词学习进度
- 支持按分类筛选
- 返回已学习、待复习、学习中词条数据

**主要参数：**
- `userId`: 用户ID
- `collection`: 分类名称（如'高考实词合集'）

**核心逻辑：**
- 查询用户词条学习记录
- 按状态分类统计（已学习、待复习、学习中）
- 返回完整的进度数据

## 技术实现

- 前端：微信小程序原生框架
- 后端：微信云开发平台
  - 云数据库：存储用户数据和课文内容
  - 云函数：处理AI请求与鉴权
- AI功能：调用大语言模型API提供文言文翻译、解析、出题等功能

## 开发环境

1. 微信开发者工具
2. 开通云开发环境
3. AppID 配置

## 开发进度

- [x] 环境搭建与基础架构
- [x] 云函数初始化
- [x] AI服务接口配置
- [x] 首页界面完善
- [x] 课文选择页开发
- [x] 课文学习页面开发
- [x] UI风格优化（中国古典风格）
- [x] 学习进度跟踪系统
- [x] 用户学习记录管理
- [x] AI内容存储优化
- [x] 每日名句功能开发
- [x] 名句收藏功能开发
- [x] 文章收藏功能开发
- [x] 我的收藏页面开发
- [x] 虚实词学习模块开发
  - [x] 学习分类展示
  - [x] 词条学习界面
  - [x] 学习进度追踪
  - [x] 分类切换功能
  - [x] 待学习状态统计显示
- [x] AI助手开发
- [x] 版本自动更新
- [ ] 用户中心开发
- [ ] 会员系统开发

## 启动项目

1. 克隆本仓库
2. 使用微信开发者工具打开项目
3. 在开发者工具中点击"云开发"，创建云开发环境
4. 部署所有云函数
5. 创建云数据库集合
6. 在微信开发者工具中点击"编译"按钮运行项目

## 最近更新内容

### 2025年8月更新
1. **版本管理**
   - 新增小程序版本自动更新管理器，提升用户体验。
2. **文档**
   - 更新项目 `README.md`，同步最新的功能和代码结构。

### 2025年6月更新

1. **虚实词学习模块**
   - 完成了虚实词学习首页UI改版，采用卡片式布局
   - 优化了学习分类展示，实现大卡片样式
   - 添加了学习进度显示功能
   - 新增待学习状态的统计显示
   - 完善了虚实词分类的词条数量显示

2. **代码优化**
   - 从首页移除了虚实词学习模块，改为独立页面
   - 删除了首页的数据库链接测试功能
   - 优化了未登录状态下的用户体验
   - 修改了未登录状态下的登录跳转逻辑

3. **UI改进**
   - 优化了虚实词学习页面的视觉效果
   - 调整了配色方案，增强了用户体验
   - 添加了多个SVG图标，提升界面美观度

## 下一步开发计划

1. **UI体验优化**
   - 完善各页面的中国风设计元素
   - 优化组件交互动效
   - 适配深色模式
   - 制作更多中国风SVG素材

2. **用户中心开发**
   - 实现个人学习数据展示
   - 开发学习统计图表功能
   - 设计会员权益与收藏管理
   - 添加学习计划和目标设置功能

## 数据库设计

采用小程序云开发数据库

### 数据集合：

#### 1. articles（文章数据表）
- `_id`: 文章唯一标识符（数据库自动生成）
- `article_id`: 文章ID（业务层面的唯一标识）
- `education_stage`: 教育阶段（小学/初中/高中）
- `grade`: 年级（一年级/七年级/高一等）
- `grade_id`: 年级编号（用于排序）
- `semester`: 学期（上学期/下学期）
- `lesson_number`: 课文序号（在教材中的编号）
- `chapter`: 章节
- `title`: 文章标题
- `author`: 文章作者
- `dynasty`: 朝代
- `full_content`: 课文内容（原文）
- `ishige`: 是否为诗歌（true为诗歌，false为文言文）
- `audio`: 音频文件链接

#### 2. article_ai_content（文章AI内容表）
- `_id`: 记录唯一标识符
- `article_id`: 关联的文章ID
- `translate`: 全文翻译内容
- `translate_updated_at`: 翻译内容更新时间
- `author_info`: 作者信息内容
- `author_info_updated_at`: 作者信息更新时间
- `background`: 背景知识内容
- `background_updated_at`: 背景知识更新时间
- `sentence_analysis`: 逐句解析内容
  - `updated_at`: 更新时间
  - `sentences`: 句子解析数组
    - `original_text`: 原句文本
    - `phonetic_notation`: 拼音标注
    - `translation`: 翻译
    - `key_words`: 关键词解析
    - `grammar_analysis`: 语法分析
    - `rhetorical_analysis`: 修辞分析
- `exercise`: 练习题内容
- `exercise_updated_at`: 练习题更新时间
- `suggested_questions`: 推荐问题内容
- `suggested_questions_updated_at`: 推荐问题更新时间
- `created_at`: 创建时间
- `updated_at`: 更新时间

#### 3. user（用户表）
- `_id`: 用户唯一标识符
- `openid`: 微信用户唯一标识
- `nickname`: 用户昵称
- `avatarUrl`: 用户头像链接
- `createdAt`: 创建时间
- `updatedAt`: 更新时间

#### 4. user_article_record（用户文章学习记录表）
- `_id`: 记录唯一标识符
- `user_id`: 用户ID（关联用户的openid）
- `article_id`: 文章ID
- `last_learn_time`: 最后学习时间
- `learn_status`: 学习状态
  - `0`: 未开始
  - `1`: 学习中
  - `2`: 已完成
- `learn_duration`: 学习时长（秒）
- `func1_clicked`: 全文翻译功能是否已点击
- `func2_clicked`: 逐句解析功能是否已点击
- `func3_clicked`: 作者介绍功能是否已点击
- `func4_clicked`: 背景知识功能是否已点击
- `func5_clicked`: 练习巩固功能是否已点击
- `func6_clicked`: AI互动功能是否已点击
- `function_clicks`: 功能点击历史记录数组
  - `name`: 功能名称
  - `time`: 点击时间
- `create_time`: 记录创建时间

#### 5. user_ai_chat (用户AI聊天记录)
- `_id`: 记录唯一标识符（自动生成）
- `userId`: 用户ID（openid）
- `messages`: 聊天消息数组
  - `id`: 消息ID
  - `role`: 角色 (`user` 或 `assistant`)
  - `content`: 消息内容
- `createdAt`: 创建时间
- `updatedAt`: 更新时间

#### 6. famous_quotes（名句数据表）
- `_id`: 名句唯一标识符
- `content`: 名句内容
- `source`: 出处
- `author`: 作者
- `dynasty`: 朝代
- `translation`: 现代汉语翻译

#### 7. user_favorite（用户收藏表）
- `_id`: 收藏记录唯一标识符
- `userId`: 用户ID
- `type`: 收藏类型（'quote'或'article'）
- `itemId`: 收藏项目ID
- `quote`: 名句数据（当type为'quote'时）
  - `content`: 名句内容
  - `source`: 出处
  - `author`: 作者
  - `dynasty`: 朝代
  - `translation`: 现代汉语翻译
- `article`: 文章数据（当type为'article'时）
  - `title`: 文章标题
  - `author`: 作者
  - `dynasty`: 朝代
- `createTime`: 收藏时间

#### 8. user_word_progress（用户虚实词学习进度表）
- `_id`: 记录唯一标识符
- `userId`: 用户ID（关联用户的openid）
- `wordId`: 词条ID（关联xushici表的word_id）
- `collection`: 所属合集（如"高考实词合集"）
- `status`: 学习状态（'learning', 'learned', 'review'）
- `lastStudied`: 最后学习时间
- `updateTime`: 记录更新时间

#### 9. xushici（虚实词数据表）
- `word_id` : 例词id，词条唯一标识符
- `word` : 例词
- `pronunciation` (读音): 词条读音
- `usage_id` (用法id): 用法唯一标识符
- `part_of_speech` (词性): 词性（动词/名词/助词等）
- `meaning` (词义): 词条含义
- `example_sentence_id` (例句id): 例句唯一标识符
- `example_sentence` (例句): 例句内容
- `source` (出处): 例句出处
- `explanation` (释义): 例句释义
- `collection` (合集): 所属合集（如"高考虚词合集"、"高考实词合集"等）

## 核心业务逻辑

### 1. 学习进度跟踪系统

蜗牛学诗文小程序实现了完整的学习进度跟踪系统，通过以下方式判断用户的学习完成度：

1. **功能使用跟踪**：
   - 记录用户使用的六大功能模块（全文翻译、逐句解析、作者介绍、背景知识、练习巩固、AI互动）
   - 当用户使用全部六个功能模块后，自动将学习状态标记为"已完成"

2. **学习时长记录**：
   - 在用户浏览文章页面时，定期记录学习时长
   - 累计计算用户在每篇文章上的总学习时间

3. **学习状态管理**：
   - 未开始(0)：用户未学习该文章或仅浏览未使用功能
   - 学习中(1)：用户已开始学习但未完成全部功能
   - 已完成(2)：用户已使用全部六个功能模块

### 2. AI内容生成与存储系统

小程序利用AI技术为每篇文言文生成多种辅助内容，并通过优化的存储系统确保内容共享和高效访问：

1. **AI内容生成**：
   - **全文翻译**：将古文翻译成现代文，便于理解
   - **逐句解析**：针对每句文言文进行详细解析，包括句法结构、关键词解释等
   - **作者介绍**：提供作者生平、创作风格等背景信息
   - **背景知识**：介绍文章的历史背景、创作背景等
   - **练习题生成**：基于文章内容自动生成练习题，巩固学习
   - **智能问答**：回答用户关于文章的任何问题

2. **内容存储优化**：
   - **合并存储模式**：同一篇文章的所有AI内容（翻译、解析、背景知识等）合并为一条记录
   - **云函数访问**：使用云函数进行数据库操作，避免客户端权限问题
   - **内容共享机制**：不同用户访问同一文章时共享相同的AI内容，避免重复生成
   - **按需生成**：仅在内容不存在时调用AI接口生成，节省资源

3. **数据存储结构**：
   - 以`article_id`为主键，确保每篇文章只有一条记录
   - 不同类型内容存储在同一记录的不同字段中
   - 特殊处理逐句解析等复杂内容类型

### 3. 用户学习数据分析

系统通过收集和分析用户学习数据，提供个性化学习体验：

1. **学习历史记录**：记录用户学习过的文章和学习状态
2. **学习时长统计**：统计用户在每篇文章和总体的学习时间
3. **功能使用偏好**：分析用户对不同功能模块的使用频率
4. **学习进度追踪**：展示用户的整体学习进度和完成情况

### 4. 名句功能与收藏系统

小程序实现了名句展示与收藏系统，丰富学习内容：

1. **每日名句**：
   - 在首页随机展示一条精选名句
   - 支持刷新获取新的名句
   - 显示名句内容、作者、朝代和现代汉语翻译

2. **收藏系统**：
   - 支持收藏喜欢的名句和文章
   - 提供"我的收藏"页面，分类展示收藏内容
   - 可随时取消收藏

3. **数据存储**：
   - 名句数据存储在`famous_quotes`集合
   - 用户收藏数据存储在`user_favorite`集合
   - 收藏记录包含完整内容，避免二次查询

## 学到的经验：
在微信小程序中，默认情况下客户端只能访问自己创建的数据，而名句数据是通过云函数生成的，可能没有正确设置数据库权限。
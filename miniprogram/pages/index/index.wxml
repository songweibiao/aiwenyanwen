<!--index.wxml-->
<wxs src="../../utils/filters.wxs" module="filters" />
<view class="container">
  <!-- 公告栏 -->
  <view class="notice-bar" wx:if="{{noticeList.length > 0 && !noticeClosed}}">
    <text class="notice-icon">📢</text>
    <view class="marquee-wrap">
      <view
        class="marquee-content"
        style="transform: translateX({{marqueeTranslateX}}rpx); transition: all {{marqueeState === 'scroll' ? marqueeDuration : 0}}s linear;"
        catchtap="onNoticeTap"
        data-url="{{currentNotice.url}}"
      >
        <text class="notice-content">{{currentNotice.content}}</text>
        <text class="notice-gap"> </text>
      </view>
    </view>
    <view class="notice-close" bindtap="closeNotice">×</view>
  </view>

  <!-- 欢迎区域 -->
  <view class="welcome-card card" bindtap="onWelcomeCardTap">
    <view class="welcome-content">
      <view class="user-info">
        <image class="user-avatar" src="{{hasUserInfo ? userInfo.avatarUrl : '/images/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="welcome-text">
          <view class="welcome-greeting">
            <text class="greeting text-secondary">{{greeting}}，</text>
            <text class="nickname text-primary-color text-bold">{{nickname || '同学'}}</text>
          </view>
          <text class="slogan text-tertiary">新的一天，一起品读经典吧</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 课堂同步学区域 -->
  <view class="study-card card">
    <view class="card-header">
      <view class="card-title">
        <image class="icon-title" src="/images/icons/classroom.svg" mode="aspectFit"/>
        <text class="title-text">课堂同步学</text>
      </view>
      <view class="grade-indicator" wx:if="{{hasSelectedCourse}}">
        <text class="grade-text text-primary-color">{{currentGrade}}</text>
      </view>
    </view>
    
    <!-- 加载状态 -->
    <view class="loading-section" wx:if="{{courseLoading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>
    
    <!-- 未选择课文时显示开始学习区域 -->
    <view class="empty-study-section" wx:elif="{{!hasSelectedCourse}}">
      <image class="empty-course-image" src="/images/common/empty-course.svg" mode="aspectFit"></image>
      <view class="empty-course-text text-lg text-bold">开启文言文学习之旅</view>
      <view class="empty-course-subtext text-secondary">选择课文后即可享受全面学习体验</view>
      <view class="btn btn-primary start-btn" bindtap="startLearning">
        <view class="start-btn-content">
          <image class="start-btn-icon" src="/images/common/book-icon.svg" mode="aspectFit"></image>
          <text>立即选择课文</text>
        </view>
        <view class="arrow-icon">
          <view class="arrow-right"></view>
        </view>
      </view>
    </view>
    
    <!-- 已选择课文时显示课文信息 -->
    <view class="study-content" wx:else>
      <view class="current-lesson">
        <view class="lesson-info">
          <text class="lesson-title text-bold">{{currentLesson}}</text>
          <view class="lesson-author" wx:if="{{selectedCourse.article.author || selectedCourse.article.dynasty}}">
            <text>{{selectedCourse.article.dynasty || ''}} · {{selectedCourse.article.author || ''}}</text>
          </view>
        </view>
        <view class="btn btn-secondary btn-xs change-btn" bindtap="changeCourse">
          <image class="change-icon" src="/images/icons/refresh.svg" mode="aspectFit"></image>
          <text>更换课程</text>
        </view>
      </view>

      <!-- 音频播放器模块 -->
      <view wx:if="{{selectedCourse.article.audio}}" class="audio-player-card">
        <view class="audio-header-row">
          <text class="audio-title">AI播客趣解</text>
          <view class="audio-speed-group">
            <block wx:for="{{audioSpeedList}}" wx:key="item">
              <view class="audio-speed-btn {{audioSpeed==item?'active':''}}" data-speed="{{item}}" bindtap="onAudioSpeedChange">{{item}}x</view>
            </block>
          </view>
        </view>
        
        <view class="audio-main">
          <view class="audio-btn-play {{audioPlaying?'playing':''}}" bindtap="{{audioPlaying?'onAudioPause':'onAudioPlay'}}">
            <view class="play-icon"></view>
            <view class="pause-icon"></view>
          </view>
          
          <view class="audio-progress-wrap">
            <view class="audio-progress-bar">
              <slider 
                class="audio-slider" 
                min="0" 
                max="{{audioDuration}}" 
                step="0.1" 
                value="{{audioCurrent}}" 
                activeColor="#8B6E4F"
                backgroundColor="rgba(139, 110, 79, 0.1)"
                block-size="12"
                block-color="#8B6E4F"
                bindchange="onAudioSliderChange"
              />
            </view>
            <view class="audio-time-row">
              <text class="audio-time-current">{{filters.formatAudioTime(audioCurrent)}}</text>
              <text class="audio-time-total">{{filters.formatAudioTime(audioDuration)}}</text>
            </view>
          </view>
        </view>
        
        <view class="audio-disclaimer">
          <text>播客内容由AI生成，发音未必准确，请仔细辨别。</text>
        </view>
      </view>

      <view class="divider"></view>

      <!-- 主要功能卡片 -->
      <view class="feature-row">
        <view class="feature-card" bindtap="goToFullTranslation">
          <view class="feature-icon">
            <image src="/images/icons/translation.svg" mode="aspectFit"></image>
          </view>
          <text class="feature-title">全文翻译</text>
          <image class="feature-bg" src="/images/common/chinese-pattern-1.svg" mode="aspectFill"></image>
        </view>
        
        <view class="feature-spacing"></view>
        
        <view class="feature-card" bindtap="goToSentenceAnalysis">
          <view class="feature-icon">
            <image src="/images/icons/analysis.svg" mode="aspectFit"></image>
          </view>
          <text class="feature-title">逐句解析</text>
          <image class="feature-bg" src="/images/common/chinese-pattern-2.svg" mode="aspectFill"></image>
        </view>
      </view>

      <view class="divider"></view>

      <!-- 功能图标行 -->
      <view class="tool-grid">
        <view class="tool-item" bindtap="goToAuthorInfo">
          <view class="tool-icon author-icon">
            <image src="/images/icons/author.svg" mode="aspectFit"></image>
          </view>
          <text class="tool-text">作者介绍</text>
        </view>
        <view class="tool-item" bindtap="goToBackground">
          <view class="tool-icon background-icon">
            <image src="/images/icons/background.svg" mode="aspectFit"></image>
          </view>
          <text class="tool-text">背景知识</text>
        </view>
        <view class="tool-item" bindtap="goToExercise">
          <view class="tool-icon exercise-icon">
            <image src="/images/icons/exercise.svg" mode="aspectFit"></image>
          </view>
          <text class="tool-text">练习巩固</text>
        </view>
        <view class="tool-item" bindtap="goToAIInteraction">
          <view class="tool-icon ai-icon">
            <image src="/images/icons/ai.svg" mode="aspectFit"></image>
          </view>
          <text class="tool-text">AI互动</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 虚实词学习区域 -->
  <view class="word-card card">
    <view class="card-header">
      <view class="card-title">
        <image class="icon-title" src="/images/icons/word.svg" mode="aspectFit"/>
        <text class="title-text">虚实词学习</text>
      </view>
      <view class="word-selector" bindtap="changeWordType">
        <text class="word-type text-primary-color">{{currentWordType}}</text>
        <view class="dropdown-icon">
          <view class="arrow-down"></view>
        </view>
      </view>
    </view>
    
    <view class="word-type-info">
      <view class="word-type-content">
        <text class="word-type-name text-bold">{{currentWordTypeName}}</text>
        <text class="word-count text-tertiary">{{currentWordType === '中考' ? '共124个' : '共186个'}}</text>
      </view>
      <view class="btn btn-secondary btn-xs change-btn" bindtap="changeWordType">
        <image class="change-icon" src="/images/icons/refresh.svg" mode="aspectFit"></image>
        <text>更换课程</text>
      </view>
    </view>
    
    <view class="word-actions">
      <view class="btn btn-primary word-btn" bindtap="goToWordStudy">学习</view>
      <view class="btn btn-secondary word-btn" bindtap="goToWordPractice">练习</view>
    </view>
  </view>

  <!-- 名句赏析卡片 -->
  <view class="quote-card card" wx:if="{{famousQuote}}">
    <view class="card-header">
      <view class="card-title">
        <image class="icon-title" src="/images/icons/quote.svg" mode="aspectFit"/>
        <text class="title-text">每日名句</text>
      </view>
      <view class="quote-actions">
        <view class="icon-btn" bindtap="refreshQuote">
          <image src="/images/icons/refresh.svg" mode="aspectFit" class="action-icon"></image>
        </view>
        <view class="icon-btn" bindtap="collectQuote">
          <image src="{{famousQuote.isCollected ? '/images/icons/star-filled.svg' : '/images/icons/star.svg'}}" mode="aspectFit" class="action-icon {{famousQuote.isCollected ? 'collected' : ''}}"></image>
        </view>
      </view>
    </view>
    
    <view class="quote-content" bindtap="goToQuoteDetail">
      <text class="quote-text">{{famousQuote.content}}</text>
      <view class="quote-source text-tertiary">——{{famousQuote.dynasty}} · {{famousQuote.author}}《{{famousQuote.source}}》</view>
      <view class="quote-translation">{{famousQuote.translation}}</view>
    </view>
  </view>

  <!-- 推广领取区域 -->
  <view class="promo-card" bindtap="goToPromotion">
    <view class="promo-content">
      <view class="promo-info">
        <text class="promo-title">文言文学习资料</text>
        <text class="promo-desc">点击复制推广码，关注公众号领取</text>
      </view>
      <view class="btn btn-light promo-btn">立即领取</view>
    </view>
  </view>
</view> 
# AI助手聊天记录功能

本功能实现了AI助手的聊天记录存储，使用户的对话历史能够持久化保存，并在不同页面间共享。

## 功能特点

1. **登录限制**：未登录用户无法使用AI助手功能，会提示登录并自动跳转到"我的"页面
2. **聊天记录存储**：将用户与AI助手的对话记录存储到云数据库中
3. **数据同步**：课文详情页的AI互动和AI助手页面的聊天记录共享同一数据源
4. **退出登录清空**：用户退出登录时自动清空AI助手聊天记录

## 部署步骤

### 1. 创建数据库集合

在云开发控制台中，创建一个名为 `user_ai_chat` 的集合，用于存储用户的聊天记录。

### 2. 部署云函数

右键点击 `cloudfunctions/userAIChat` 文件夹，选择"上传并部署：云端安装依赖"，等待部署完成。

### 3. 设置数据库权限

为确保数据安全，建议设置 `user_ai_chat` 集合的权限为：
- 创建：仅创建者可写
- 读取：仅创建者可读
- 更新：仅创建者可写
- 删除：仅创建者可写

## 数据结构

### user_ai_chat 集合

```json
{
  "_id": "记录唯一标识符（自动生成）",
  "userId": "用户ID（openid）",
  "messages": [
    {
      "id": 1234567890,
      "role": "assistant",
      "content": "你好！我是李白，有什么文言文、古诗、文学相关问题，尽管问我吧~"
    },
    {
      "id": 1234567891,
      "role": "user",
      "content": "请介绍一下你自己"
    },
    {
      "id": 1234567892,
      "role": "assistant",
      "content": "我是李白，唐代伟大的浪漫主义诗人..."
    }
  ],
  "createdAt": "2023-05-20T12:00:00.000Z",
  "updatedAt": "2023-05-20T12:10:00.000Z"
}
```

## 使用流程

1. 用户登录后，可以在AI助手页面与AI进行对话
2. 在课文详情页的AI互动功能中，用户可以点击推荐问题或输入自定义问题
3. 课文详情页的问题会自动同步到AI助手页面，并获取AI回答
4. 所有对话记录会自动保存到云数据库中
5. 用户退出登录后，聊天记录会被清空

## 注意事项

1. 确保用户在使用AI助手功能前已登录，否则会提示登录
2. 云函数部署后需要测试功能是否正常
3. 如需修改聊天记录存储逻辑，请修改 `userAIChat` 云函数和相关页面代码 